%%                     This source code is part of
%% 
%%                   D  E  N  S  T  O  O  L  K  I  T
%% 
%%                          VERSION: 1.3.0
%% 
%%              Contributors: Juan Manuel Solano-Altamirano
%%                            Julio Manuel Hernandez-Perez
%%         Copyright (c) 2013-2015, Juan Manuel Solano-Altamirano
%%                                  <jmsolanoalt@gmail.com>
%% 
%%  -------------------------------------------------------------------
%%  Copyright (c) 2013-2015 Juan Manuel Solano Altamirano.
%%  Permission is granted to copy, distribute and/or modify this document
%%  under the terms of the GNU Free Documentation License, Version 1.3
%%  or any later version published by the Free Software Foundation;
%%  with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
%%  A copy of the license is included in the section entitled "GNU
%%  Free Documentation License".
%%  ---------------------------------------------------------------------
%% 
%%  If you want to redistribute modifications of the suite, please
%%  consider to include your modifications in our official release.
%%  We will be pleased to consider the inclusion of your contributions.
%%  within the official distribution. Please keep in mind that
%%  scientific software is very special, and version control is 
%%  crucial for tracing bugs. If in despite of this you distribute
%%  your modified version, please do not call it DensToolKit.
%% 
%%  If you find DensToolKit useful, we humbly ask that you cite
%%  the paper(s) on the package --- you can find them on the top
%%  README file.
%% 
%% ************************************************************************
%%%%

%**********************************************************************************************
%**********************************************************************************************
\chapter{Available density fields}\label{sec:availablefields}
%**********************************************************************************************
%**********************************************************************************************

As is well known from Quantum Mechanics theory, all the information of a quantum system is
contained in the wave function. For a molecular system,  the wave function, $\psi(\boldsymbol{r})$,
can be spanned by $M$ molecular orbitals $\chi_m(\boldsymbol{r})$ ($m=1,\dots,M$, and these
molecular orbitals can be obtained by any of the self consistent field methods available)
%
\begin{equation}
   \psi(\boldsymbol{r})=\sum_{m=1}^{M}\sqrt{C_m}\chi_m(\boldsymbol{r}).
\end{equation}
%
In turn, each molecular orbital can be spanned by a linear combination of Gaussian basis functions:
\begin{equation}
   \chi_m(\boldsymbol{r})=\sum_{\dA=\done}^{\dN}D_{m\dA}\phi_{\dA}(\boldsymbol{r}-\boldsymbol{R}_{\dA}).
\end{equation}
%
We have used here a slightly different notation (as opposed to the traditional notation) to denote
primitives in order to clearly separate the different index types that one encounters while handling
molecular wave functions. We use upper case dotted indices for identifying Gaussian basis functions.
Under our notation, each individual basis function is uniquely identified with a dotted index, and
each basis function has associated three integers ($a^1_{\dA}$, $a^2_{\dA}$, and $a^3_{\dA}$), and a
point which denotes the centre of the primitive $\boldsymbol{R}_{\dA}$ (with this notation a
primitive centre $\boldsymbol{R}_{\dA}$ can be the same than another primitive centre
$\boldsymbol{R}_{\dB}$, \textit{i.e.} the index associates the Cartesian coordinates of a nucleus
to a particular basis function, rather than associating a basis function with a nucleus;
similar behaviour is observed for the integers $a^i_{\dA}$). This index naming is actually more
natural for reading and understanding the \texttt{wfn} and \texttt{wfx} files. 

Each Gaussian basis function (or primitive) is given by
%
\begin{equation}\label{eq:primitivedef}
   \phi_{\dA}(\boldsymbol{r})=(x^1-R^1_{\dA})^{a^1_{\dA}}(x^2-R^2_{\dA})^{a^2_{\dA}}(x^3-R^3_{\dA})^{a^3_{\dA}}
   \exp\left(-\alpha_{\dA}(\boldsymbol{r}-\boldsymbol{R}_{\dA})^2\right),
\end{equation}
%
and the normalization constants are already included in the coefficients $D_{m\dA}$.

Finally, unless otherwise specified, we will assume that Im$(\phi_{\dA})=0$. While this is not true in general, it does hold for the Gaussian basis sets we will be interested in (\textit{i.e.,} those obtained as \texttt{wfn} or \texttt{wfx} files from Gaussian, Gamess, MolPro, NWChem, etc.)


%..............................................................................................
\subsection*{Pseudopotentials}
%..............................................................................................

In the current version of \DTK{}, the wavefunctions with pseudopotentials can be
input. However, the wavefunction file is restricted to have \texttt{wfx} format
and the Gaussian primitives used for describing the core electrons must be in a
single \texttt{<Additional Electron Density Function (EDF)>} block (see
\cite{bib:webwfxformat} for more details).

For the core electrons, there will be a single ``orbital'', and the core electron
density  is obtained as follows
%
\begin{equation}\label{eq:rhoadotdef}
  \rho_{\textrm{core}}=\sum_{\bA=\bar 1}^{\bar E}C_{\bA}\rho_{\bA}.
\end{equation}
%
In Eq. (\ref{eq:rhoadotdef}), another index type is used. This time, the index runs
from one to the number of EDF primitives (denoted by $\bar E$), 
each $\rho_{\bA}$ is a $s$-type Gaussian basis
function, \textit{i.e.}
%
\begin{equation}%\label{eq:}
  \rho_{\bA}\equiv\exp\left( -\beta_{\bA}(\boldsymbol r-\boldsymbol R_{\bA})^2 \right)
  =\left( \exp\left( -\alpha_{\bA}(\boldsymbol r_{\bA}-\boldsymbol R_{\bA})^2 \right) \right)^2
  \equiv\phi_{\bA}^2.
\end{equation}
%
The coefficients $C_{\bA}$ can be easily differentiated from $C_m$ just by
looking at the type of index, and 
%
\begin{equation}%\label{eq:}
  \alpha_{\bA}=\frac{\beta_{\bA}}{2}.
\end{equation}
%


In the \texttt{wfx} file, the coefficients $C_{\bA}$ are referred to as the
\texttt{``EDF Primitive Coefficients''}, and $\beta_{\bA}$ are the so-called
\texttt{``EDF Primitive Exponents''}.
Clearly, there exists a very close relationship between dotted functions, and barred
functions, however we keep the barred index to remind the subtle differences 
in how each part of the total electron density must be treated.

Another feature (noteworthy to our purposes) is that pseudopotentials are 
spanned by $s$-type primitives, which reduces many mathematical developments.



%----------------------------------------------------------------------------------------------
\section{Electron density ($\rho$)}
%----------------------------------------------------------------------------------------------

%..............................................................................................
\subsection{Regular expansion}
%..............................................................................................

Hereafter, we will use the term ``Regular Expansion'' whenever we are describing
the standard Gaussian-type orbital expansions, \textit{ie.e} the wavefunction
does not use pseudopotentials.

The electron density is therefore given by
%
\begin{equation}
   \rho(\boldsymbol{r})=\sum_{m=1}^{M}C_m\sum_{\dA=\done}^{\dP}\sum_{\dB=\done}^{\dP}D_{m\dA}D_{m\dB}
                        \phi_{\dA}(\boldsymbol{r})\phi_{\dB}(\boldsymbol{r}),
\end{equation}
%
where $\dP$ is the total number of primitives used in the expansion of the wave function.

Defining the density matrix, $c_{\dA\dB}$, as
%
\begin{equation}
   c_{\dA\dB}\equiv\sum_{m=1}^{M}C_mD_{m\dA}D_{m\dB},
\end{equation}
%
the electron density can be written as follows:
%
\begin{equation}\label{eq:rhodeflong}
   \rho(\boldsymbol{r})=\sum_{\dA=\done}^{\dP}\sum_{\dB=\done}^{\dP}
      c_{\dA\dB}\phi_{\dA}(\boldsymbol{r})\phi_{\dB}(\boldsymbol{r}).
\end{equation}
%

Computationally, we can reduce the number of computations by using the following algorithm
%
\begin{equation}
   \rho(\boldsymbol{r})=\sum_{\dA}\left\{\phi_{\dA}\left[c_{\dA\dA}\phi_{\dA}+2\sum_{\dB>\dA}c_{\dA\dB}\phi_{\dB}\right]\right\}.
\end{equation}
%
This is the algorithm implemented in \DTK{} whenever the function allows it, and is twice as efficient as the direct computation posed by Eq. (\ref{eq:rhodeflong}).

In what follows, unless stated otherwise, we will follow the Einstein summation convention, this is, a summation will be implied every time an index appears repeated in a single term, and the trivial vector arguments (such as the spatial dependence) will be dropped. Hence, the electron density is simply written as
%
\begin{equation}
   \rho=c_{\dA\dB}\phi_{\dA}\phi_{\dB}.
\end{equation}
%

While this notation is not customary in chemistry fields, it allows oneself to perform all the tensor gymnastics developed in other fields of physics, as we will see below.

Also, we will use latin indices to denote the Cartesian components of a vector. Therefore the $i$-th component of a vector $\boldsymbol{A}$ is
%
\begin{equation}
   [\boldsymbol{A}]^{i}\equiv A^i,
\end{equation}
%
and the $i$-th partial derivative of a function $\varphi$ is denoted as follows:
%
\begin{equation}
   \frac{\partial\varphi}{\partial x^i}\equiv\partial_i\varphi.
\end{equation}
%

The Einstein summation convention is also implied every time a latin index appears twice in the
same term. The limits of the summation should be obvious depending on the index type. For
instance upper case, dotted indices will run from $\dot{1}$ to the number of primitives in
the expansion ($\dot{P}$); while latin, lower case indices will run from 1 to 3 (since they
are used for cartesian components). This is one of the advantages of introducing such an
index naming system.

%..............................................................................................
\subsection{Pseudopotentials}
%..............................................................................................

For wavefunctions with pseudopotentials, the coefficients $C_{\bA}$ can be coded if needed
in a $C_{\bA\bB}$ form as follows:
%
\begin{equation}%\label{eq:}
  C_{\bA\bB}=\left\{
  \begin{array}{ll}
    0,&\qquad \bA\neq\bB\\
    C_{\bA},&\qquad\bA=\bB
  \end{array}
  \right..
\end{equation}
%
The above definition will serve to closely follow mathematical developments used with
dotted indices (regular primitives), since most of the field definitions will have
a direct mirror by changing $\dA\to\bA$ (as we will see below). The Einstein
summation convention also applies for barred indices.

The electron density is thus given by
%
\begin{equation}\label{eq:rhowithpsdpot}
  \rho=C_{\dA\dB}\phi_{\dA}\phi_{\dB}+C_{\bA}\rho_{\bA}
      =C_{\dA\dB}\phi_{\dA}\phi_{\dB}+C_{\bA\bB}\phi_{\bA}\phi_{\bB}.
\end{equation}
%

From the type of index it is easy to know their range. The only
subtlety that we must always bear in mind when dealing with pseudopotentials is that
dotted indices run from $\done$ to the number of regular (or valence) primitives,
for simplicity also denoted by $\dN$,
and the barred indices run from $\bar 1$ to the number of EDF primitives,
denoted by $\bar E$.

Notice that when dealing with the core density, there is no mathematical
difference between using $\rho_{\bA}$ or $\phi_{\bA}$, as they differ each
other only by the exponent value ($\beta_{\bA}$ \textit{vs} $\alpha_{\bA}$).
However, in computational terms, the difference is huge because all
non-diagonal terms of $C_{\bA\bB}$ are zero, which reduces the number
of operations to be proportional to $\bar E$. This feature, along with the
$s$-type character of the primitives/density will be often
exploited below, and the primitive product (last equality of Eq.
(\ref{eq:rhowithpsdpot})) will be avoided wherever we can.



%----------------------------------------------------------------------------------------------
\section{Gradient of the electron density ($\nabla\rho$)}\label{sec:gradrho}
%----------------------------------------------------------------------------------------------

With the notation proposed in the previous section, the gradient of the electron density can be evaluated easily:
%
\begin{equation}
   \partial_i\rho=c_{\dA\dB}\partial_i(\phi_{\dA}\phi_{\dB})=2c_{\dA\dB}\phi_{\dA}\partial_i\phi_{\dB},
\end{equation}
%
where we have used the symmetry properties of $c_{\dA\dB}$ in the last equality, and
%
\begin{eqnarray}
   \partial_i\phi_{\dB}&=&\left(-2\alpha_{\dB}(x^i-R^i_{\dB})^{a^i_{\dB}+1}+
   a^i_{\dB}(x^i-R^i_{\dB})^{a^i_{\dB}-1}\right)\prod_{j\neq i}(x^j-R^j_{\dB})^{a^j_{\dB}}\nonumber\\
                       & &\times\exp\left(-\alpha_{\dB}(\boldsymbol{r}-\boldsymbol{R}_{\dB})^2\right)
                       \label{eq:diphidbexplicit}
\end{eqnarray}
%
(no summation in Eq. (\ref{eq:diphidbexplicit})).

The case of wavefunctions with pseudopotentials is trivially found by replacing 
dots by bars in every equations related to primitives. From now on, we will ommit
comments related to pseudopotentials, unless there is some non-trivial remark.
For instance, in finding the gradient of the core electron density, the total
derivatives can be reduced to
%
\begin{equation}%\label{eq:}
   \partial_i\rho=2c_{\dA\dB}\phi_{\dA}\partial_i\phi_{\dB}
   +C_{\bA}\partial_i\rho_{\bA}.
\end{equation}
%


%..............................................................................................
\subsection{Higher derivatives the electron density}
%..............................................................................................

By defining the objects
%
\begin{equation}
   \phi^i_{\dA}(x^i)\equiv(x^i-R^i_{\dA})^{a^i_{\dA}}\exp\left(-\alpha_{\dA}(x^i-R^i_{\dA})^2\right),
   \qquad\qquad\textrm{(no summation)}
\end{equation}
%
%
\begin{eqnarray}
  D_{i\dA}^0&\equiv&\phi^i_{\dA},\nonumber\\
   D_{i\dA}^n&\equiv&\partial_i^n\phi^i_{\dA},\qquad\qquad\textrm{(no summation)}
\end{eqnarray}
%
and recalling that
%
\begin{equation}
   \partial_i\phi^j_{\dA}=0,\qquad\qquad\textrm{for }i\neq j,
\end{equation}
%
we can obtain any derivative of the primitives in any combination:
%
\begin{equation}
  \partial_1^l\partial_2^m\partial_3^n\phi_{\dA}=D_{1\dA}^lD_{2\dA}^mD_{3\dA}^n.
  \qquad\textrm{(no summation)}.
\end{equation}
%

The object $D_{i\dA}^n$ has the properties:
%
\begin{equation}
  D^a_{i\dA}D^a_{i\dA}=D^{a+b}_{i\dA},\qquad\qquad\textrm{(no summation)}
\end{equation}
%
and the primitive can be expressed as
%
\begin{equation}%\label{eq:}
  \phi_{\dA}=D^0_{1\dA}D^0_{2\dA}D^0_{3\dA}, \qquad\textrm{(no summation)}
\end{equation}
%


Therefore, higher derivatives of the electron density, such as the Hessian, can be obtained from expression as
%
\begin{equation}
  \partial_i\partial_j\phi_{\dA}=D_{i\dA}^1D_{j\dA}^1D^0_{k\dA}, \qquad\textrm{(no summation)}
\end{equation}
%
While this notation may seem cumbersome, it simplifies the implementation of higher derivatives of the electron density by the use of arrays. For example, the Hessian of the electron density is given by
%
\begin{equation}
   \partial_i\partial_j\rho=2c_{\dA\dB}\left(\phi_{\dA}\partial_i\partial_j\phi_{\dB}+\partial_i\phi_{\dA}\partial_j\phi_{\dB}\right).
\end{equation}
%

In \DTK{} we implemented functions to evaluate up to fourth derivatives of the primitives
(when seeking critical points of LOL,
see \S\ref{sec:topolanalysis}).


%..............................................................................................
\subsubsection{Pseudopotentials}
%..............................................................................................

The Hessian of wavefunctions with pseudopotentials are found by
%
\begin{equation}%\label{eq:}
  \partial_i\partial_j\rho=2c_{\dA\dB}\left(\phi_{\dA}\partial_i\partial_j\phi_{\dB}+\partial_i\phi_{\dA}\partial_j\phi_{\dB}\right)+C_{\bA}\partial_i\partial_j\rho_{\bA}.
\end{equation}
%


%----------------------------------------------------------------------------------------------
\section{Magnitude of $\nabla\rho$}
%----------------------------------------------------------------------------------------------
This function follows directly from the gradient of the electron density, and is given by
%
\begin{equation}
   |\nabla\rho|=\sqrt{\nabla\rho\cdot\nabla\rho}=\sqrt{\partial_k\rho\partial_k\rho},
\end{equation}
%
and $\partial_i\rho$ is evaluated as explained in \S\ref{sec:gradrho}.
%----------------------------------------------------------------------------------------------
\section{Laplacian of $\rho$ ($\nabla^2\rho$)}
%----------------------------------------------------------------------------------------------

The Laplacian of the electron density is evaluated by means of
%
\begin{equation}
   \nabla^2\rho=\partial_k\partial_k\rho=2c_{\dA\dB}\left(\partial_k\phi_{\dA}\partial_k\phi_{\dB}+\phi_{\dA}\partial_k\partial_k\phi_{\dB}\right)
\end{equation}
%
If pseudopotentials are used, the Laplacian is then
%
\begin{equation}%\label{eq:}
   \partial_k\partial_k\rho=
   2c_{\dA\dB}\left(\partial_k\phi_{\dA}\partial_k\phi_{\dB}+
   \phi_{\dA}\partial_k\partial_k\phi_{\dB}\right)
   +C_{\bA}\partial_k\partial_k\rho_{\bA}.
\end{equation}
%


%----------------------------------------------------------------------------------------------
\section{Kinetic Energy $G$}
%----------------------------------------------------------------------------------------------

The definition of the Kinetic energy density $G$ we implemented in \DTK{} is (in terms of the density matrix $c_{\dA\dB}$)
%
\begin{equation}\label{eq:KinetEnergyGDef}
   G=\frac{1}{2}c_{\dA\dB}\nabla\phi_{\dA}^*\cdot\nabla\phi_{\dB}=\frac{1}{2}\partial_k\phi_{\dA}\left(c_{\dA\dB}\partial_k\phi_{\dB}\right).
\end{equation}
%

Let us recall that some improvements on the speed of \DTK{} rely on the fact that we are assuming that the primitives are pure-real. The parenthesis in the last equation denotes that in \DTK{} we first save the sum of the three terms $c_{\dA\dB}\partial_i\phi_{\dB}$ within the inner loop, and after this loop is completed, we multiply and add each one of these sums by $\partial_i\phi_{\dA}$ on the outer loop. While this procedure may seem a bit obscure, it improves the speed of the computations.

The kinentic energy $G$ of a wavefunction that uses pseudopotentials is reduced to
%
\begin{equation}%\label{eq:}
  G=\frac{1}{2}\sum_{\dA\dB}\partial_k\phi_{\dA}\left(c_{\dA\dB}\partial_k\phi_{\dB}\right)
  +\frac{1}{2}\sum_{\bA}C_{\bA}\left( \partial_k\phi_{\bA}\cdot\partial_k\phi_{\bA} \right).
\end{equation}
%



%----------------------------------------------------------------------------------------------
\section{Kinetic Energy $K$}
%----------------------------------------------------------------------------------------------

The Kinetic energy density $K$ definition we implemented in \DTK{} is
%
\begin{equation}
   K(\boldsymbol{r})=\frac{1}{4}c_{\dA\dB}\left(\phi_{\dA}^*\nabla^2\phi_{\dB}+\phi_{\dB}^*\nabla^2\phi_{\dA}\right)=\frac{1}{2}\phi_{\dA}\left(c_{\dA\dB}\partial_k\partial_k\phi_{\dB}\right).
\end{equation}
%

For wavefunctions with pseudopotentials, this field is given by
%
\begin{equation}%\label{eq:}
  K(\boldsymbol{r})=\frac{1}{2}\sum_{\dA\dB}
    \phi_{\dA}\left(c_{\dA\dB}\partial_k\partial_k\phi_{\dB}\right)
    +\frac{1}{2}\sum_{\bA}C_{\bA}\phi_{\bA}\partial_k\partial_k\phi_{\bA}.
\end{equation}
%


%----------------------------------------------------------------------------------------------
\section{Electron Localization Function (ELF)}
%----------------------------------------------------------------------------------------------

We follow the standard definition of ELF, which we denote as $\eta(\boldsymbol{r})$:
%
\begin{equation}
   \eta(\boldsymbol{r})=\frac{1}{1+[D(\boldsymbol{r})/D_h(\boldsymbol{r})]^2}.
\end{equation}
%
Here $D(\boldsymbol{r})$ gives the probability density of finding a same-spin electron \cite{bib:becke1990}, and has the value
%
\begin{equation}
   D=G-\frac{1}{8}\frac{|\nabla\rho|^2}{\rho},
\end{equation}
%
with $G$ (the Kinetic energy density $G$), $\nabla\rho$, and $\rho$ evaluated as in previous sections, while $D_h$ is given by
%
\begin{equation}
   D_h=\frac{3}{10}(3\pi^2)^{2/3}\rho^{5/3}.
\end{equation}
%

%----------------------------------------------------------------------------------------------
\section{Localized Orbital Locator (LOL)}
%----------------------------------------------------------------------------------------------

\DTK{} evaluates the localized orbital locator (denoted by the letter $\gamma$) as
%
\begin{equation}
   \gamma=\frac{1}{1+\tau},
\end{equation}
%
where
%
\begin{equation}
   \tau=\frac{G}{D_h},
\end{equation}
%
and $G$ and $D_h$ as defined in previous sections.

%----------------------------------------------------------------------------------------------
\section{Momentum density}
%----------------------------------------------------------------------------------------------
For the implementation of this field, we closely follow the procedure given in Ref. \cite{bib:kaijser1977}. In terms of the density matrix, the momentum density is given by
%
\begin{equation}\label{eq:momdensdef}
   \pi(\boldsymbol{p})=\hat{\phi}_{\dA}^*(\boldsymbol{p})c_{\dA\dB}\hat{\phi}_{\dB}(\boldsymbol{p}),
\end{equation}
%
where $\hat{\phi}_{\dA}(\boldsymbol{p})$ is the Fourier transform of the primitive $\phi_{\dA}(\boldsymbol{r})$, defined as follows:
%
\begin{equation}
   \hat{\phi}_{\dA}(\boldsymbol{p})=\frac{1}{(2\pi)^{2/3}}\int\exp\left(-i\boldsymbol{p}\cdot\boldsymbol{r}\right)\phi_{\dA}(\boldsymbol{r})d\boldsymbol{r}.
\end{equation}
%

A table of the Fourier transforms of the cartesian primitives is listed in Ref. \cite{bib:kaijser1977}. We reproduce here the first five terms, which are the ones we used in this version of \DTK{} (since the normalization constants of the primitives are already taken into account in the density matrix, the expressions in Table \ref{tab:momdensang} do not include the normalization constants).

\begin{table}[ht!]
\begin{center}
\begin{tabular}{||c|c|c||}
\hline
\hline
   $n$ & $\phi^k(x_k)$ & $\hat{\phi}^k(p_k)$\\
\hline
   0 & $\exp(-\alpha x_k^2)$  & $\frac{1}{(2\alpha)^{1/2}}\exp(-ip_kR_k)\exp(-p_k^2/(4\alpha))$ \\
\hline
   1 & $x_k\exp(-\alpha x_k^2)$ & $-i\frac{p_k}{(2\alpha)^{3/2}}\exp(-ip_kR_k)\exp(-p_k^2/(4\alpha))$\\
\hline
   2 & $x_k^2\exp(-\alpha x_k^2)$ & $\frac{2\alpha-p_k^2}{(2\alpha)^{5/2}}\exp(-ip_kR_k)\exp(-p_k^2/(4\alpha))$ \\
\hline
   3 & $x_k^3\exp(-\alpha x_k^2)$ & $i\frac{p_k(p_k^2-6\alpha)}{(2\alpha)^{7/2}}\exp(-ip_kR_k)\exp(-p_k^2/(4\alpha))$ \\
\hline
   4 & $x_k^4\exp(-\alpha x_k^2)$ & $\frac{p_k^4-12\alpha p_k^2+12\alpha^2}{(2\alpha)^{9/2}}\exp(-ip_kR_k)\exp(-p_k^2/(4\alpha))$ \\
\hline
\hline
\end{tabular}
\caption{Fourier transforms of Cartesian GTOs with orbital exponent $\alpha$, centre $R_k$, and angular power $n$ (single coordinate). No summation is implied here.}\label{tab:momdensang}
\end{center}
\end{table}

For the evaluation of this field, we must account for the imaginary terms of the Fourier terms. \DTK{} exploit the library \texttt{<complex>} distributed as standard library of \texttt{C++}. 

%..............................................................................................
\subsection{Pseudopotentials}
%..............................................................................................

Since the core electron density is an expansion of $s$-type primitives, and recalling
the linearity of the equations, the momentum density follows directly from Eq.
(\ref{eq:momdensdef}) (by replacing $\dA\to\bA$, which is found to be
%
\begin{equation}%\label{eq:}
  \pi(\boldsymbol{p})=\sum_{\dA\dB}
   \hat{\phi}_{\dA}^*(\boldsymbol{p})c_{\dA\dB}\hat{\phi}_{\dB}(\boldsymbol{p})+
   \sum_{\bA}
   \hat{\phi}_{\bA}^*(\boldsymbol{p})C_{\bA}\hat{\phi}_{\bA}(\boldsymbol{p}).
\end{equation}
%


%----------------------------------------------------------------------------------------------
\section{Shannon entropy density}
%----------------------------------------------------------------------------------------------

This field cannot be further optimized beyond the optimization achieved in the electron density. In fact, the Shannon entropy density field is given by
%
\begin{equation}
   S_{\rho}(\boldsymbol{r})=-\rho(\boldsymbol{r})\ln\big(\rho(\boldsymbol{r})\big),
\end{equation}
%
which uses the implemented algorithm for evaluating $\rho(\boldsymbol{r})$.

Let us not forget this is a density field, not the integrated Shannon entropy. Whether or not this field is useful as a density will not be discussed here.

The Shannon entropy in momentum space is given by (also a density field):
%
\begin{equation}
   S_{\pi}(\boldsymbol{p})=-\pi(\boldsymbol{p})\ln\big(\pi(\boldsymbol{p})\big),
\end{equation}
%
and it also uses a simple call to evaluate $\pi(\boldsymbol{p})$, as given by \ref{eq:momdensdef}.


%----------------------------------------------------------------------------------------------
\section{Density matrix of order 1}
%----------------------------------------------------------------------------------------------

In terms of the density matrix, the Density Matrix of order 1 (DM1, and denoted by the symbol $\Gamma(\boldsymbol{r},\boldsymbol{r}')$) is given by
%
\begin{equation}
   \Gamma(\boldsymbol{r},\boldsymbol{r}')=\phi_{\dA}(\boldsymbol{r})\big(c_{\dA\dB}\phi_{\dB}(\boldsymbol{r}')\big).
\end{equation}
%

The Density Matrix of order 1 of wavefunctions with pseudopotentials is
%
\begin{equation}%\label{eq:}
  \Gamma(\boldsymbol{r},\boldsymbol{r}')=\sum_{\dA\dB}
  \phi_{\dA}(\boldsymbol{r})\big(c_{\dA\dB}\phi_{\dB}(\boldsymbol{r}')\big)
  +\sum_{\bA}
  \phi_{\bA}(\boldsymbol{r})\big(C_{\bA}\phi_{\bA}(\boldsymbol{r}')\big)
\end{equation}
%


%----------------------------------------------------------------------------------------------
\section{Electrostatic potential}
%----------------------------------------------------------------------------------------------

The electrostatic potential is given by
%
\begin{equation}
   V(\boldsymbol{r})=\sum_{a=1}^{N_{nuc}}\frac{Z_a}{|\boldsymbol{r}-\boldsymbol{R}_a|}-\int\frac{\rho(\boldsymbol{x})}{|\boldsymbol{r}-\boldsymbol{x}|}d\boldsymbol{x},
\end{equation}
%
where $\boldsymbol{R}_A$ is the vector indicating the spatial position of nuclei $A$, whose charge is $Z_A$, and $\rho(\boldsymbol{x})$ is the electron density at the dummy point $\boldsymbol{x}$. In terms of the density matrix, the electrostatic potential is given by
%
\begin{equation}
   V(\boldsymbol{r})=\sum_{a=1}^{N_{nuc}}\frac{Z_a}{|\boldsymbol{r}-\boldsymbol{R}_a|}-c_{\dA\dB}\int\frac{\phi_{\dA}(\boldsymbol{x})\phi_{\dB}(\boldsymbol{x})}{|\boldsymbol{r}-\boldsymbol{x}|}d\boldsymbol{x}.
\end{equation}
%
Hence, the evaluation of the electrostatic potential is reduced to evaluate the integral
%
\begin{equation}
   \mathfrak{I}_{\dA\dB}=\mathfrak{I}_{\dA\dB}(\boldsymbol{r})=\int\frac{\phi_{\dA}(\boldsymbol{x})\phi_{\dB}(\boldsymbol{x})}{|\boldsymbol{r}-\boldsymbol{x}|}d\boldsymbol{x}.
\end{equation}
%
For the remainder of this section, we will not use the Einstein summation convention. The last integral is written as
%
\begin{equation}
\mathfrak{I}_{\dA\dB}=\int\frac{d\boldsymbol{x}}{|\boldsymbol{r}-\boldsymbol{x}|}
                   \exp\left(-\alpha_{\dA}|\boldsymbol{x}-\boldsymbol{R}_{\dA}|^2
                             -\alpha_{\dB}|\boldsymbol{x}-\boldsymbol{R}_{\dB}|^2\right)
                   \prod_i(x^i-R_{\dA}^i)^{a_{\dA}^i}(x^i-R_{\dB}^i)^{a_{\dB}^i}.
\end{equation}
%
Let us define the following constants
%
\begin{eqnarray}
   \alpha_{\dA\dB}&\equiv&\alpha_{\dA}+\alpha_{\dB},\\
   \boldsymbol{R}_{\dA\dB}&\equiv&\frac{\alpha_{\dA}\boldsymbol{R}_{\dA}+\alpha_{\dB}\boldsymbol{R}_{\dB}}{\alpha_{\dA\dB}}, \textrm{\ and}\\
   E_{\dA\dB}&\equiv&\exp\left(-\frac{\alpha_{\dA}\alpha_{\dB}}{\alpha_{\dA\dB}}(\boldsymbol{R}_{\dA}-\boldsymbol{R}_{\dB})^2\right),
\end{eqnarray}
%
which have the following symmetry properties
\begin{equation}
   \alpha_{\dA\dB}=\alpha_{\dB\dA},\qquad\boldsymbol{R}_{\dA\dB}=\boldsymbol{R}_{\dB\dA},\qquad\textrm{ and }
   \qquad E_{\dA\dB}=E_{\dB\dA}.
\end{equation}
With this notation, the use of the same letter for the exponents and vector positions does not introduce confusion since the new quantities carry two indices, as opposed to the single index carried by the original single centred Gaussian. Thus, the integral now can be expressed as
%
\begin{equation}\label{eq:iabred}
   \mathfrak{I}_{\dA\dB}=E_{\dA\dB}\int\frac{d\boldsymbol{x}}{|\boldsymbol{x}-\boldsymbol{r}|}
      \exp\left(-\alpha_{\dA\dB}|\boldsymbol{x}-\boldsymbol{R}_{\dA\dB}|^2\right)
      \prod_i(x^i-R_{\dA}^i)^{a_{\dA}^i}(x^i-R_{\dB}^i)^{a_{\dB}^i},
\end{equation}
%
which is also a symmteric function in the indices $\dA$ and $\dB$:
\begin{equation}
   \mathfrak{I}_{\dA\dB}=\mathfrak{I}_{\dB\dA}.
\end{equation}

Applying the Laplace transform given by Eq. (\ref{eq:laptransfdef}),
%
\begin{equation}\label{eq:laptransfdef}
   \frac{1}{|\boldsymbol{x}-\boldsymbol{r}|}=\frac{2}{\sqrt{\pi}}\int_0^{\infty}\exp\left(-u^2(\boldsymbol{x}-\boldsymbol{r})^2\right),
\end{equation}
%
into Eq. (\ref{eq:iabred}) yields
%
\begin{equation}
   \mathfrak{I}_{\dA\dB}=\frac{2E_{\dA\dB}}{\sqrt{\pi}}\int_0^{\infty}\!\!\!\!\!\!du\int d\boldsymbol{x}
   \exp\left(-\alpha_{\dA\dB}(\boldsymbol{x}-\boldsymbol{R}_{\dA\dB})^2-u^2(\boldsymbol{x}-\boldsymbol{r})^2\prod_i(x^i-R^i_{\dA})^{a^i_{\dA}}(x^i-R^i_{\dB})^{a^i_{\dB}}\right).
\end{equation}
%
It is convenient to use the variable
%
\begin{equation}
   t^2=\frac{u^2}{\alpha_{\dA\dB}+u^2},
\end{equation}
%
hence
%
\begin{eqnarray}
   \mathfrak{I}_{\dA\dB}&=&2E_{\dA\dB}\sqrt{\frac{\alpha_{\dA\dB}}{\pi}}
               \int_0^1\frac{1}{(1-t^2)^{3/2}}\Bigg\{\Bigg.\nonumber\\
   & &\qquad\times\int\Bigg[\Big.\exp\left(-\alpha_{\dA\dB}(\boldsymbol{x}-\boldsymbol{R}_{\dA\dB})^2
           -\frac{\alpha_{\dA\dB}t^2}{1-t^2}(\boldsymbol{x}-\boldsymbol{r})^2\right)\nonumber\\
   & & \qquad\qquad\times\prod_i(x^i-R_{\dA}^i)^{a_{\dA}^i}(x^i-R_{\dB}^i)^{a_{\dB}^i}d\boldsymbol{x}\Bigg.\Bigg]\Bigg.\Bigg\}dt\\
    &=&\frac{2E_{\dA\dB}\pi}{\alpha_{\dA\dB}}
        \int_0^1dt\Bigg\{\Bigg.\nonumber\\
    & &\prod_i\Bigg[\Bigg.\sqrt{\frac{\alpha_{\dA\dB}}{\pi(1-t^2)}}
        \int dx^i(x^i-R_{\dA}^i)^{a_{\dA}^i}(x^i-R_{\dB}^i)^{a_{\dB}^i}\nonumber\\
    & &\qquad\qquad\times\exp\left(-\alpha_{\dA\dB}(x^i-R^i_{\dA\dB})^2-\frac{\alpha_{\dA\dB}t^2}{1-t^2}(x^i-r^i)^2\right)\Bigg.\Bigg]\Bigg.\Bigg\}.
\end{eqnarray}
%
The terms $(x^i-R_{\dA}^i)^{a_{\dA}^i}(x^i-R_{\dB}^i)^{a_{\dB}^i}$ can be expanded in a series of Hermite polynomials of ($x^i-R^i_{\dA}$) and ($R^i_{\dA}-R^i_{\dB}$), and the resultant expansion can then be analytically integrated. In \DTK{} we coded an implementation that closely follows the method proposed by McMurchie \textit{et. al.} \cite{bib:mcmurchie1978}. However, we use our own implementation of the Boys function (denoted as $F_n(x)$), which offers relative accuracy of $F_n(x)$ to at least O$(10^{-12})$ for the range $0\leq x\leq1000$, and $0\leq n\leq6$. \DTK{} is coded in an \textit{as-needed} basis, thus we are not concerned with higher order terms of $n$ since 6 is the maximum value needed for the computations supported by \DTK.

For this field, we also exploit the symmetry of the product $c_{\dA\dB}\phi_{\dA}\phi_{\dB}$, hence
%
\begin{eqnarray}
   V(\boldsymbol{r})&=&\sum_a\frac{Z_a}{|\boldsymbol{r}-\boldsymbol{R}_a|}-
   \sum_{\dA}\left(c_{\dA\dA}\int\frac{\phi_{\dA}^2(\boldsymbol{x})}{|\boldsymbol{r}-\boldsymbol{x}|}d\boldsymbol{x}+2\sum_{\dB>\dA}c_{\dA\dB}\int\frac{\phi_{\dA}(\boldsymbol{x})\phi_{\dB}(\boldsymbol{x})}{|\boldsymbol{r}-\boldsymbol{x}|}d\boldsymbol{x}\right)\nonumber\\
   &=&\sum_a\frac{Z_a}{|\boldsymbol{r}-\boldsymbol{R}_a|}-
   \sum_{\dA}\left(c_{\dA\dA}\mathfrak{I}_{\dA\dA}+2\sum_{\dB>\dA}c_{\dA\dB}\mathfrak{I}_{\dA\dB}\right).
\end{eqnarray}
%

%..............................................................................................
\subsection{Pseudopotentials}
%..............................................................................................

Finally, the electrostatic potential of a wavefunction that contains pseudpotentials
in its expansion is
%
\begin{equation}%\label{eq:}
  V(\boldsymbol{r})=\sum_a\frac{Z_a}{|\boldsymbol{r}-\boldsymbol{R}_a|}-
   \sum_{\dA}\left(c_{\dA\dA}\mathfrak{I}_{\dA\dA}+
   2\sum_{\dB>\dA}c_{\dA\dB}\mathfrak{I}_{\dA\dB}\right)+
   \sum_{\bA}C_{\bA}\mathfrak{I}_{\bA\bA}.
\end{equation}
%

%----------------------------------------------------------------------------------------------
\section{Virial Potential Energy Density}
%----------------------------------------------------------------------------------------------
This field derives from the local form of the virial theorem, wich relates the
Laplacian of the electron density function,
$\nabla^2\rho$, to the local electronic kinetic energy density $G(r)$. This fiels was
taken from Ref. \cite{bib:espinosa1998}, and it is given by:
\begin{equation}
	V(\boldsymbol{r})= \frac{1}{4} \nabla^2\rho(\boldsymbol{r})-2G(\boldsymbol{r})	
\end{equation}

Usually, this field is used for measuring hydrogen bonds stength.
No optimizations beyond those already implemented in $G(r)$ and $\nabla^2\rho$
were added.

%----------------------------------------------------------------------------------------------
\section{Magnitude of the Localized Electron Detector (LED)}
%----------------------------------------------------------------------------------------------
This field stems from two fundamental fields, namely $\rho$ and $\nabla\rho$, thus
it is directly evaluated using these fields. By definition, LED (denoted as $\tilde{\boldsymbol P}$) is the vector
\cite{bib:bohorquez2010a}:
%
\begin{equation}\label{eq:LEDDef}
-\tilde{\boldsymbol P}=\frac{\hslash\nabla\rho}{2\rho}.
\end{equation}
%
Since \DTK{} uses atomic units, in Eq. (\ref{eq:LEDDef}) is actually equal to one.
Furthermore, in \dtkversion, we have no convention to save vector fields on cubes,
thus we only provide the magnitude of $\tilde{\boldsymbol P}$, \textit{i.e.}:
%
\begin{equation}\label{eq:MagLEDDef}
|\tilde{\boldsymbol P}|=\frac{|\nabla\rho|}{2\rho}.
\end{equation}
%

There is one remark here, since \texttt{dtkplane} can draw vector fields,
in this program we do provide the actual vector $\tilde{\boldsymbol P}=(1/2)\nabla\rho/\rho$.
Other programs only provide the magnitude shown in Eq. (\ref{eq:MagLEDDef}).

%----------------------------------------------------------------------------------------------
\section{Region of Slow Electrons (RoSE)}
%----------------------------------------------------------------------------------------------
This field is implemented in \DTK{} directly as defined in the original reference \cite{jacobsen2013}:
%
\begin{equation}%\label{eq:}
  \nu_{\pm}=\frac{\tau_0-\tau}{\tau_0+\tau},
\end{equation}
%
where
%
\begin{equation}%\label{eq:}
  \tau_0=\frac{3}{10}\left( 3\pi^2 \right)^{2/3}\rho^{5/3},
\end{equation}
%
and
%
\begin{equation}%\label{eq:}
  \tau=\frac{1}{2}\sum_i\left<\nabla_i\psi^*\cdot\nabla_i\psi\right>.
\end{equation}
%
\textit{I.e.}, $\tau$ is the kinetic energy density $G$ defined in Eq. (\ref{eq:KinetEnergyGDef}).
Consequently, this field is computed using the implementations for $G$ and $\rho$.

%----------------------------------------------------------------------------------------------
\section{Reduced Gradient of Density}
%----------------------------------------------------------------------------------------------
Since the field is derived from the ED ($\rho$) and its gradient, in \DTK{} we
compute it with no special implementation. According to Johnson \textit{et al.} \cite{bib:johnson2010}, the
reduced density gradient is defined as
%
\begin{equation}%\label{eq:}
  s=\frac{1}{2(3\pi^2)^{1/3}}\frac{|\nabla\rho|}{\rho^{4/3}}.
\end{equation}
%

This field is used to characterize Non Covalent Interactions (NCI). In computational terms, the
NCI is a correlation between $\rho$ and $s$. However, in practice,
the NCI requires a bit of human intervention for determining appropriate cutoffs.
To this end, in \DTK, we provide the script \texttt{dtkgetnciplot} to determine
the cutoffs (see Section \ref{sec:dtkgetnciplotdesc}, and Ref. \cite{bib:contreras2011}
for further details), as well as to generate VMD templates to visualize the NCI
index.

